package com.example.secondhand.service;

import com.alipay.api.AlipayApiException;
import com.alipay.api.AlipayClient;
import com.alipay.api.request.AlipayTradePagePayRequest;
import com.alipay.api.request.AlipayTradeQueryRequest;
import com.alipay.api.response.AlipayTradeQueryResponse;
import com.example.secondhand.entity.Order;
import com.example.secondhand.entity.PaymentOrder;
import com.example.secondhand.entity.PaymentLog;
import com.example.secondhand.entity.Product;
import com.example.secondhand.entity.TimeoutTask;
import com.example.secondhand.entity.OrderItem;
import com.example.secondhand.repository.OrderRepository;
import com.example.secondhand.repository.PaymentOrderRepository;
import com.example.secondhand.repository.PaymentLogRepository;
import com.example.secondhand.repository.ProductRepository;
import com.example.secondhand.repository.OrderItemRepository;
import com.alibaba.fastjson.JSON;
import com.example.secondhand.event.PaymentSuccessEvent;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

/**
 * æ”¯ä»˜æœåŠ¡
 * å¤„ç†æ”¯ä»˜ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 */
@Service
@Transactional
public class PaymentService {

    @Autowired
    private AlipayClient alipayClient;

    @Autowired
    private OrderRepository orderRepository;

    @Autowired
    private PaymentOrderRepository paymentOrderRepository;

    @Autowired
    private PaymentLogRepository paymentLogRepository;

    @Autowired
    private ProductRepository productRepository;

    @Autowired
    private OrderItemRepository orderItemRepository;

    @Autowired
    private InventoryService inventoryService;

    @Autowired
    private ApplicationEventPublisher eventPublisher;


    /**
 * å¤„ç†æ”¯ä»˜å®å¼‚æ­¥å›è°ƒé€šçŸ¥
 * @param params æ”¯ä»˜å®å›ä¼ çš„å‚æ•°
 * @return æ˜¯å¦å¤„ç†æˆåŠŸ
 */
public boolean handleAlipayCallback(Map<String, String> params) {
    try {
        // 1. è·å–è®¢å•å·
        String orderNo = params.get("out_trade_no");
        String tradeStatus = params.get("trade_status");

        // 2. trade_status å¿…é¡»æ˜¯ TRADE_SUCCESS
        if (!"TRADE_SUCCESS".equals(tradeStatus)) {
            System.out.println("å›è°ƒ trade_status éæˆåŠŸçŠ¶æ€ï¼Œå¿½ç•¥ï¼š" + tradeStatus);
            return false;
        }

        // 3. æŸ¥è¯¢è®¢å•
        Optional<Order> optional = orderRepository.findById(orderNo);
        if (!optional.isPresent()) {
            System.out.println("è®¢å•ä¸å­˜åœ¨ï¼š" + orderNo);
            return false;
        }

        Order order = optional.get();

        // 4. æ›´æ–°è®¢å•çŠ¶æ€ â†’ å¾…å‘è´§
        order.setStatus(Order.OrderStatus.PENDING_SHIPMENT);
        orderRepository.save(order);

        // 5. æ›´æ–° PaymentOrder
        Optional<PaymentOrder> payOpt = paymentOrderRepository.findById(orderNo);
        if (payOpt.isPresent()) {
            PaymentOrder po = payOpt.get();
            po.setPaid(true);
            paymentOrderRepository.save(po);
        }

        // 6. å–æ¶ˆè¶…æ—¶ä»»åŠ¡
        timeoutTaskManager.cancelTimeoutByOrder(
                orderNo,
                TimeoutTask.TaskType.PAYMENT_TIMEOUT,
                "æ”¯ä»˜å›è°ƒæˆåŠŸå–æ¶ˆè¶…æ—¶"
        );

        System.out.println("è®¢å• " + orderNo + " å·²æ›´æ–°ä¸ºå¾…å‘è´§");
        return true;

    } catch (Exception e) {
        e.printStackTrace();
        return false;
    }
}


    /**
     * å‘èµ·æ”¯ä»˜å®æ”¯ä»˜
     * @param orderNo è®¢å•å·
     * @param userId ç”¨æˆ·ID
     * @param returnUrl åŒæ­¥å›è°ƒåœ°å€
     * @param notifyUrl å¼‚æ­¥å›è°ƒåœ°å€
     * @return æ”¯ä»˜è¡¨å•HTML
     */
    public String initiateAlipayPayment(String orderNo, Long userId, String returnUrl, String notifyUrl) {
        long startTime = System.currentTimeMillis();
        PaymentLog log = null;
        
        try {
            // 1. éªŒè¯è®¢å•å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
            Order order = orderRepository.findByOrderNo(orderNo)
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
            
            if (!order.getBuyerId().equals(userId)) {
                throw new RuntimeException("æ— æƒé™æ”¯ä»˜æ­¤è®¢å•");
            }

            // 2. éªŒè¯è®¢å•çŠ¶æ€
            if (order.getStatus() != Order.OrderStatus.PENDING_PAYMENT) {
                throw new RuntimeException("è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜ï¼Œå½“å‰çŠ¶æ€ï¼š" + order.getStatus().getDescription());
            }

            // 3. éªŒè¯åº“å­˜
            validateInventory(orderNo);

            // 4. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ”¯ä»˜è®¢å•
            Optional<PaymentOrder> existingPayment = paymentOrderRepository.findById(orderNo);
            PaymentOrder paymentOrder;
            
            if (existingPayment.isPresent()) {
                paymentOrder = existingPayment.get();
                // å¦‚æœå·²æ”¯ä»˜ï¼Œä¸èƒ½é‡å¤æ”¯ä»˜
                if (paymentOrder.isPaid()) {
                    throw new RuntimeException("è®¢å•å·²æ”¯ä»˜ï¼Œæ— éœ€é‡å¤æ”¯ä»˜");
                }
                // å¦‚æœæ˜¯å…¶ä»–çŠ¶æ€ï¼Œå¯ä»¥é‡æ–°æ”¯ä»˜
                if (paymentOrder.canTransitionTo(PaymentOrder.PaymentStatus.PENDING)) {
                    paymentOrder.transitionTo(PaymentOrder.PaymentStatus.PENDING);
                }
            } else {
                // åˆ›å»ºæ–°çš„æ”¯ä»˜è®¢å•
                String subject = generatePaymentSubject(orderNo);
                String body = generatePaymentBody(orderNo);
                
                paymentOrder = new PaymentOrder(
                    orderNo,
                    order.getTotalAmount(),
                    order.getBuyerId(),
                    order.getBuyerName(),
                    subject,
                    body
                );
                paymentOrder = paymentOrderRepository.save(paymentOrder);
            }

            // 5. åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜è¯·æ±‚
            AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
            request.setReturnUrl(returnUrl);
            request.setNotifyUrl(notifyUrl);

            // 6. è®¾ç½®ä¸šåŠ¡å‚æ•°
            Map<String, Object> bizContent = new HashMap<>();
            bizContent.put("out_trade_no", orderNo);
            bizContent.put("product_code", "FAST_INSTANT_TRADE_PAY");
            bizContent.put("total_amount", paymentOrder.getAmount().toString());
            bizContent.put("subject", paymentOrder.getSubject());
            bizContent.put("body", paymentOrder.getBody());
            bizContent.put("timeout_express", paymentOrder.getTimeoutExpress());

            request.setBizContent(JSON.toJSONString(bizContent));

            // 7. ç”Ÿæˆæ”¯ä»˜è¡¨å•
            String paymentForm = alipayClient.pageExecute(request).getBody();

            // 8. è®°å½•æ”¯ä»˜å‘èµ·æ—¥å¿—
            log = PaymentLog.info(orderNo, PaymentLog.LogOperation.PAYMENT_INIT, 
                "æ”¯ä»˜å‘èµ·æˆåŠŸï¼Œé‡‘é¢ï¼š" + paymentOrder.getAmount())
                .withContext(userId, null, null)
                .withExecutionTime(startTime);
            log.setRequestData(JSON.toJSONString(bizContent));
            paymentLogRepository.save(log);

            return paymentForm;

        } catch (AlipayApiException e) {
            // è®°å½•æ”¯ä»˜å®APIå¼‚å¸¸
            log = PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_INIT, e)
                .withContext(userId, null, null)
                .withExecutionTime(startTime);
            paymentLogRepository.save(log);
            throw new RuntimeException("æ”¯ä»˜å®æ¥å£è°ƒç”¨å¤±è´¥ï¼š" + e.getMessage(), e);
            
        } catch (Exception e) {
            // è®°å½•å…¶ä»–å¼‚å¸¸
            log = PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_INIT, e)
                .withContext(userId, null, null)
                .withExecutionTime(startTime);
            paymentLogRepository.save(log);
            throw e;
        }
    }

    /**
     * éªŒè¯è®¢å•åº“å­˜
     * @param orderNo è®¢å•å·
     */
    private void validateInventory(String orderNo) {
        List<OrderItem> orderItems = orderItemRepository.findByOrderOrderNo(orderNo);
        
        for (OrderItem item : orderItems) {
            Product product = productRepository.findById(item.getProductId())
                    .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨ï¼š" + item.getProductName()));
            
            // æ£€æŸ¥å•†å“çŠ¶æ€
            if (product.getStatus() != 1) {
                throw new RuntimeException("å•†å“å·²ä¸‹æ¶ï¼š" + product.getName());
            }
            
            // æ£€æŸ¥åº“å­˜
            if (product.getQuantity() < item.getQuantity()) {
                throw new RuntimeException("å•†å“åº“å­˜ä¸è¶³ï¼š" + product.getName() + 
                    "ï¼Œéœ€è¦ï¼š" + item.getQuantity() + "ï¼Œåº“å­˜ï¼š" + product.getQuantity());
            }
        }
    }

    /**
     * ç”Ÿæˆæ”¯ä»˜æ ‡é¢˜
     * @param orderNo è®¢å•å·
     * @return æ”¯ä»˜æ ‡é¢˜
     */
    private String generatePaymentSubject(String orderNo) {
        List<OrderItem> orderItems = orderItemRepository.findByOrderOrderNo(orderNo);
        
        if (orderItems.isEmpty()) {
            return "äºŒæ‰‹å•†å“æ”¯ä»˜";
        }
        
        if (orderItems.size() == 1) {
            return orderItems.get(0).getProductName();
        }
        
        return orderItems.get(0).getProductName() + "ç­‰" + orderItems.size() + "ä»¶å•†å“";
    }

    /**
     * ç”Ÿæˆæ”¯ä»˜æè¿°
     * @param orderNo è®¢å•å·
     * @return æ”¯ä»˜æè¿°
     */
    private String generatePaymentBody(String orderNo) {
        List<OrderItem> orderItems = orderItemRepository.findByOrderOrderNo(orderNo);
        
        StringBuilder body = new StringBuilder("äºŒæ‰‹å•†å“äº¤æ˜“ï¼š");
        for (int i = 0; i < Math.min(orderItems.size(), 3); i++) {
            if (i > 0) {
                body.append("ã€");
            }
            OrderItem item = orderItems.get(i);
            body.append(item.getProductName()).append("Ã—").append(item.getQuantity());
        }
        
        if (orderItems.size() > 3) {
            body.append("ç­‰").append(orderItems.size()).append("ä»¶å•†å“");
        }
        
        return body.toString();
    }

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
     * @param orderNo è®¢å•å·
     * @return æ”¯ä»˜è®¢å•
     */
    @Transactional(readOnly = true)
    public Optional<PaymentOrder> getPaymentStatus(String orderNo) {
        return paymentOrderRepository.findById(orderNo);
    }

    /**
     * ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€
     * @param orderNo è®¢å•å·
     * @return æ”¯ä»˜å®æŸ¥è¯¢ç»“æœ
     */
    public AlipayTradeQueryResponse queryAlipayTradeStatus(String orderNo) {
        long startTime = System.currentTimeMillis();
        PaymentLog log = null;
        
        try {
            AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();
            
            Map<String, Object> bizContent = new HashMap<>();
            bizContent.put("out_trade_no", orderNo);
            request.setBizContent(JSON.toJSONString(bizContent));
            
            AlipayTradeQueryResponse response = alipayClient.execute(request);
            
            // è®°å½•æŸ¥è¯¢æ—¥å¿—
            log = PaymentLog.info(orderNo, PaymentLog.LogOperation.PAYMENT_QUERY, 
                "æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢æˆåŠŸ")
                .withExecutionTime(startTime);
            log.setRequestData(JSON.toJSONString(bizContent));
            log.setResponseData(JSON.toJSONString(response));
            paymentLogRepository.save(log);
            
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ ¹æ®æŸ¥è¯¢ç»“æœåŒæ­¥æœ¬åœ°çŠ¶æ€
            if (response.isSuccess()) {
                String tradeStatus = response.getTradeStatus();
                if ("TRADE_SUCCESS".equals(tradeStatus) || "TRADE_FINISHED".equals(tradeStatus)) {
                    // æ”¯ä»˜æˆåŠŸï¼ŒåŒæ­¥æœ¬åœ°çŠ¶æ€
                    syncLocalPaymentStatus(orderNo, response.getTradeNo(), tradeStatus);
                }
            }
            
            return response;
            
        } catch (AlipayApiException e) {
            log = PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_QUERY, e)
                .withExecutionTime(startTime);
            paymentLogRepository.save(log);
            throw new RuntimeException("æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥ï¼š" + e.getMessage(), e);
        }
    }

    /**
     * åŒæ­¥æœ¬åœ°æ”¯ä»˜çŠ¶æ€
     * @param orderNo è®¢å•å·
     * @param alipayTradeNo æ”¯ä»˜å®äº¤æ˜“å·
     * @param tradeStatus äº¤æ˜“çŠ¶æ€
     */
    private void syncLocalPaymentStatus(String orderNo, String alipayTradeNo, String tradeStatus) {
        try {
            // è·å–æ”¯ä»˜è®¢å•
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            if (paymentOrderOpt.isEmpty()) {
                return; // æ”¯ä»˜è®¢å•ä¸å­˜åœ¨ï¼Œè·³è¿‡
            }
            
            PaymentOrder paymentOrder = paymentOrderOpt.get();
            
            // å¦‚æœå·²ç»æ˜¯å·²æ”¯ä»˜çŠ¶æ€ï¼Œè·³è¿‡
            if (paymentOrder.isPaid()) {
                return;
            }
            
            // æ›´æ–°æ”¯ä»˜è®¢å•çŠ¶æ€
            paymentOrder.setAlipayTradeNo(alipayTradeNo);
            if (paymentOrder.canTransitionTo(PaymentOrder.PaymentStatus.PAID)) {
                paymentOrder.transitionTo(PaymentOrder.PaymentStatus.PAID);
                paymentOrderRepository.save(paymentOrder);
                
                // ç¡®è®¤åº“å­˜æ‰£å‡
                inventoryService.confirmInventory(orderNo);
                
                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ›´æ–°è®¢å•çŠ¶æ€æ—¶æ£€æŸ¥å½“å‰çŠ¶æ€ï¼Œé˜²æ­¢è¢«è¶…æ—¶ä»»åŠ¡è¦†ç›–
                Order order = orderRepository.findByOrderNo(orderNo).orElse(null);
                if (order != null) {
                    // åªæœ‰åœ¨å¾…ä»˜æ¬¾çŠ¶æ€æ—¶æ‰æ›´æ–°ä¸ºå¾…å‘è´§ï¼Œå¦‚æœå·²ç»æ˜¯å·²å–æ¶ˆçŠ¶æ€åˆ™æ¢å¤
                    if (order.getStatus() == Order.OrderStatus.PENDING_PAYMENT || 
                        order.getStatus() == Order.OrderStatus.CANCELLED) {
                        order.setStatus(Order.OrderStatus.PENDING_SHIPMENT);
                        orderRepository.save(order);
                        
                        // ğŸ”¥ æ”¯ä»˜æˆåŠŸåå‘å¸ƒäº‹ä»¶ï¼Œå–æ¶ˆè®¢å•è¶…æ—¶ä»»åŠ¡ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
                        publishPaymentSuccessEvent(orderNo, alipayTradeNo, tradeStatus);
                        
                        // è®°å½•çŠ¶æ€åŒæ­¥æ—¥å¿—
                        PaymentLog.info(orderNo, PaymentLog.LogOperation.STATUS_UPDATE, 
                            "ä¸»åŠ¨æŸ¥è¯¢å‘ç°æ”¯ä»˜æˆåŠŸï¼Œå·²åŒæ­¥è®¢å•çŠ¶æ€ä¸ºå¾…å‘è´§ï¼Œå¹¶å–æ¶ˆè¶…æ—¶ä»»åŠ¡")
                            .withAlipayTradeNo(alipayTradeNo);
                    }
                }
            }
            
        } catch (Exception e) {
            // è®°å½•é”™è¯¯ä½†ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“æŸ¥è¯¢ç»“æœè¿”å›
            PaymentLog.error(orderNo, PaymentLog.LogOperation.STATUS_UPDATE, e)
                .withAlipayTradeNo(alipayTradeNo);
        }
    }

    /**
     * å‘å¸ƒæ”¯ä»˜æˆåŠŸäº‹ä»¶ï¼Œå–æ¶ˆè®¢å•è¶…æ—¶ä»»åŠ¡
     * @param orderNo è®¢å•å·
     * @param alipayTradeNo æ”¯ä»˜å®äº¤æ˜“å·
     * @param tradeStatus äº¤æ˜“çŠ¶æ€
     */
    private void publishPaymentSuccessEvent(String orderNo, String alipayTradeNo, String tradeStatus) {
        try {
            PaymentSuccessEvent event = new PaymentSuccessEvent(this, orderNo, alipayTradeNo, tradeStatus);
            eventPublisher.publishEvent(event);
            
            PaymentLog.info(orderNo, PaymentLog.LogOperation.STATUS_UPDATE, 
                "æ”¯ä»˜æˆåŠŸäº‹ä»¶å·²å‘å¸ƒï¼Œå°†å–æ¶ˆè®¢å•è¶…æ—¶ä»»åŠ¡")
                .withAlipayTradeNo(alipayTradeNo);
        } catch (Exception e) {
            // è®°å½•é”™è¯¯ä½†ä¸æŠ›å‡ºå¼‚å¸¸
            PaymentLog.warn(orderNo, PaymentLog.LogOperation.STATUS_UPDATE, 
                "å‘å¸ƒæ”¯ä»˜æˆåŠŸäº‹ä»¶å¤±è´¥: " + e.getMessage())
                .withAlipayTradeNo(alipayTradeNo);
        }
    }

    /**
     * å–æ¶ˆæ”¯ä»˜
     * @param orderNo è®¢å•å·
     * @param userId ç”¨æˆ·ID
     */
    public void cancelPayment(String orderNo, Long userId) {
        long startTime = System.currentTimeMillis();
        
        try {
            // éªŒè¯æƒé™
            Order order = orderRepository.findByOrderNo(orderNo)
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
            
            if (!order.getBuyerId().equals(userId)) {
                throw new RuntimeException("æ— æƒé™æ“ä½œæ­¤è®¢å•");
            }
            
            // æ›´æ–°æ”¯ä»˜è®¢å•çŠ¶æ€
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            if (paymentOrderOpt.isPresent()) {
                PaymentOrder paymentOrder = paymentOrderOpt.get();
                if (paymentOrder.canCancel()) {
                    paymentOrder.transitionTo(PaymentOrder.PaymentStatus.CANCELLED);
                    paymentOrderRepository.save(paymentOrder);
                }
            }
            
            // è®°å½•å–æ¶ˆæ—¥å¿—
            PaymentLog log = PaymentLog.info(orderNo, PaymentLog.LogOperation.PAYMENT_CANCEL, 
                "ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆæ”¯ä»˜")
                .withContext(userId, null, null)
                .withExecutionTime(startTime);
            paymentLogRepository.save(log);
            
        } catch (Exception e) {
            PaymentLog log = PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_CANCEL, e)
                .withContext(userId, null, null)
                .withExecutionTime(startTime);
            paymentLogRepository.save(log);
            throw e;
        }
    }

    /**
     * è·å–æ”¯ä»˜å†å²è®°å½•
     * @param orderNo è®¢å•å·
     * @return æ”¯ä»˜æ—¥å¿—åˆ—è¡¨
     */
    @Transactional(readOnly = true)
    public List<PaymentLog> getPaymentHistory(String orderNo) {
        return paymentLogRepository.findByOrderNoOrderByCreateTimeDesc(orderNo);
    }

    /**
     * æ£€æŸ¥è®¢å•æ˜¯å¦å¯ä»¥æ”¯ä»˜
     * @param orderNo è®¢å•å·
     * @param userId ç”¨æˆ·ID
     * @return æ£€æŸ¥ç»“æœ
     */
    @Transactional(readOnly = true)
    public Map<String, Object> checkPaymentEligibility(String orderNo, Long userId) {
        Map<String, Object> result = new HashMap<>();
        
        try {
            // éªŒè¯è®¢å•
            Order order = orderRepository.findByOrderNo(orderNo)
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
            
            if (!order.getBuyerId().equals(userId)) {
                throw new RuntimeException("æ— æƒé™æ”¯ä»˜æ­¤è®¢å•");
            }
            
            // æ£€æŸ¥è®¢å•çŠ¶æ€
            if (order.getStatus() != Order.OrderStatus.PENDING_PAYMENT) {
                result.put("canPay", false);
                result.put("reason", "è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜ï¼š" + order.getStatus().getDescription());
                return result;
            }
            
            // æ£€æŸ¥åº“å­˜
            try {
                validateInventory(orderNo);
            } catch (Exception e) {
                result.put("canPay", false);
                result.put("reason", e.getMessage());
                return result;
            }
            
            // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            if (paymentOrderOpt.isPresent()) {
                PaymentOrder paymentOrder = paymentOrderOpt.get();
                if (paymentOrder.isPaid()) {
                    result.put("canPay", false);
                    result.put("reason", "è®¢å•å·²æ”¯ä»˜");
                    return result;
                }
            }
            
            result.put("canPay", true);
            result.put("orderAmount", order.getTotalAmount());
            result.put("orderStatus", order.getStatus());
            
        } catch (Exception e) {
            result.put("canPay", false);
            result.put("reason", e.getMessage());
        }
        
        return result;
    }

    /**
     * å¤„ç†æ”¯ä»˜å®å¼‚æ­¥å›è°ƒé€šçŸ¥
     * @param params å›è°ƒå‚æ•°
     * @return å¤„ç†ç»“æœ
     */
    public String handleAlipayCallback(Map<String, String> params) {
        long startTime = System.currentTimeMillis();
        String orderNo = params.get("out_trade_no");
        String alipayTradeNo = params.get("trade_no");
        PaymentLog log = null;
        
        try {
            // 1. è®°å½•å›è°ƒæ¥æ”¶æ—¥å¿—
            log = PaymentLog.info(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, 
                "æ¥æ”¶åˆ°æ”¯ä»˜å®å¼‚æ­¥é€šçŸ¥")
                .withAlipayTradeNo(alipayTradeNo)
                .withExecutionTime(startTime);
            log.setRequestData(JSON.toJSONString(params));
            paymentLogRepository.save(log);

            // 2. éªŒè¯ç­¾å
            if (!verifyAlipaySignature(params)) {
                log = PaymentLog.error(orderNo, PaymentLog.LogOperation.SIGNATURE_VERIFY, 
                    "æ”¯ä»˜å®å›è°ƒç­¾åéªŒè¯å¤±è´¥")
                    .withAlipayTradeNo(alipayTradeNo)
                    .withExecutionTime(startTime);
                log.setRequestData(JSON.toJSONString(params));
                paymentLogRepository.save(log);
                return "failure";
            }

            // 3. å¹‚ç­‰æ€§æ£€æŸ¥
            if (isCallbackProcessed(orderNo, alipayTradeNo)) {
                log = PaymentLog.info(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, 
                    "å›è°ƒå·²å¤„ç†ï¼Œè·³è¿‡é‡å¤å¤„ç†")
                    .withAlipayTradeNo(alipayTradeNo)
                    .withExecutionTime(startTime);
                paymentLogRepository.save(log);
                return "success";
            }

            // 4. å¤„ç†æ”¯ä»˜ç»“æœ
            String tradeStatus = params.get("trade_status");
            boolean processed = processPaymentResult(orderNo, alipayTradeNo, tradeStatus, params);
            
            if (processed) {
                log = PaymentLog.info(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, 
                    "æ”¯ä»˜å›è°ƒå¤„ç†æˆåŠŸï¼Œäº¤æ˜“çŠ¶æ€ï¼š" + tradeStatus)
                    .withAlipayTradeNo(alipayTradeNo)
                    .withExecutionTime(startTime);
                log.setResponseData("å¤„ç†æˆåŠŸ");
                paymentLogRepository.save(log);
                return "success";
            } else {
                log = PaymentLog.warn(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, 
                    "æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥ï¼Œäº¤æ˜“çŠ¶æ€ï¼š" + tradeStatus)
                    .withAlipayTradeNo(alipayTradeNo)
                    .withExecutionTime(startTime);
                paymentLogRepository.save(log);
                return "failure";
            }

        } catch (Exception e) {
            log = PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, e)
                .withAlipayTradeNo(alipayTradeNo)
                .withExecutionTime(startTime);
            log.setRequestData(JSON.toJSONString(params));
            paymentLogRepository.save(log);
            return "failure";
        }
    }

    /**
     * éªŒè¯æ”¯ä»˜å®å›è°ƒç­¾å
     * @param params å›è°ƒå‚æ•°
     * @return éªŒè¯ç»“æœ
     */
    private boolean verifyAlipaySignature(Map<String, String> params) {
        try {
            // ä½¿ç”¨æ”¯ä»˜å®SDKéªŒè¯ç­¾å
            return com.alipay.api.internal.util.AlipaySignature.rsaCheckV1(
                params, 
                getAlipayPublicKey(), 
                "UTF-8", 
                "RSA2"
            );
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * è·å–æ”¯ä»˜å®å…¬é’¥ï¼ˆä»é…ç½®ä¸­è·å–ï¼‰
     * @return æ”¯ä»˜å®å…¬é’¥
     */
    private String getAlipayPublicKey() {
        // è¿™é‡Œåº”è¯¥ä»é…ç½®æ–‡ä»¶æˆ–é…ç½®ç±»ä¸­è·å–
        return "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmoAMdCwoU7bxQpnEMgGD9AXDLahcT0HseNZbWNB8kEhESAvxXBX0d1Dy+SagTkp8a8c3VMCZf1sJU8txFZ42efnqglg0tP196WRG8PP5OuJGx++UdLXYFakXlVq2zVe+BWynXHGIe9Porv+R523hXoawH5oJqE0f6ztHtujNWjkGIOUJ9URCA0G84h0L0ICTY3khSo8iBttP2nUlmKrKFh556cNkBvGSbNxx6/F7K7CN5kbRX6gjw3hi9/RXG75gdz1Le0J3nfm+A1PYdqlRMs1W/Hqe8ULXSDwRT62zMiHyXReqb6UQHRkkohh01Xbo65lKLN8MkkOCe64JwCPdmQIDAQAB";
    }

    /**
     * æ£€æŸ¥å›è°ƒæ˜¯å¦å·²å¤„ç†ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
     * @param orderNo è®¢å•å·
     * @param alipayTradeNo æ”¯ä»˜å®äº¤æ˜“å·
     * @return æ˜¯å¦å·²å¤„ç†
     */
    private boolean isCallbackProcessed(String orderNo, String alipayTradeNo) {
        // æ£€æŸ¥æ”¯ä»˜è®¢å•çŠ¶æ€
        Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
        if (paymentOrderOpt.isPresent()) {
            PaymentOrder paymentOrder = paymentOrderOpt.get();
            // å¦‚æœå·²ç»æ˜¯å·²æ”¯ä»˜çŠ¶æ€ä¸”æ”¯ä»˜å®äº¤æ˜“å·åŒ¹é…ï¼Œè¯´æ˜å·²å¤„ç†
            return paymentOrder.isPaid() && 
                   alipayTradeNo.equals(paymentOrder.getAlipayTradeNo());
        }
        
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒæ”¯ä»˜å®äº¤æ˜“å·çš„å·²æ”¯ä»˜è®¢å•
        Optional<PaymentOrder> existingOrder = paymentOrderRepository.findByAlipayTradeNo(alipayTradeNo);
        return existingOrder.isPresent() && existingOrder.get().isPaid();
    }

    /**
     * å¤„ç†æ”¯ä»˜ç»“æœ
     * @param orderNo è®¢å•å·
     * @param alipayTradeNo æ”¯ä»˜å®äº¤æ˜“å·
     * @param tradeStatus äº¤æ˜“çŠ¶æ€
     * @param params å›è°ƒå‚æ•°
     * @return å¤„ç†ç»“æœ
     */
    private boolean processPaymentResult(String orderNo, String alipayTradeNo, 
                                       String tradeStatus, Map<String, String> params) {
        try {
            // è·å–æ”¯ä»˜è®¢å•
            PaymentOrder paymentOrder = paymentOrderRepository.findById(orderNo)
                    .orElseThrow(() -> new RuntimeException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨"));

            // è®¾ç½®æ”¯ä»˜å®äº¤æ˜“å·
            paymentOrder.setAlipayTradeNo(alipayTradeNo);
            paymentOrder.setCallbackData(JSON.toJSONString(params));

            // æ ¹æ®äº¤æ˜“çŠ¶æ€å¤„ç†
            switch (tradeStatus) {
                case "TRADE_SUCCESS":
                case "TRADE_FINISHED":
                    // æ”¯ä»˜æˆåŠŸ
                    return handlePaymentSuccess(paymentOrder, params);
                    
                case "TRADE_CLOSED":
                    // äº¤æ˜“å…³é—­
                    return handlePaymentClosed(paymentOrder, params);
                    
                case "WAIT_BUYER_PAY":
                    // ç­‰å¾…ä¹°å®¶ä»˜æ¬¾ï¼ˆé€šå¸¸ä¸ä¼šåœ¨å¼‚æ­¥é€šçŸ¥ä¸­å‡ºç°ï¼‰
                    return handlePaymentPending(paymentOrder, params);
                    
                default:
                    // æœªçŸ¥çŠ¶æ€
                    PaymentLog.warn(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, 
                        "æœªçŸ¥çš„äº¤æ˜“çŠ¶æ€ï¼š" + tradeStatus)
                        .withAlipayTradeNo(alipayTradeNo);
                    return false;
            }

        } catch (Exception e) {
            PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_CALLBACK, e)
                .withAlipayTradeNo(alipayTradeNo);
            return false;
        }
    }

    /**
     * å¤„ç†æ”¯ä»˜æˆåŠŸ
     * @param paymentOrder æ”¯ä»˜è®¢å•
     * @param params å›è°ƒå‚æ•°
     * @return å¤„ç†ç»“æœ
     */
    private boolean handlePaymentSuccess(PaymentOrder paymentOrder, Map<String, String> params) {
        try {
            // æ›´æ–°æ”¯ä»˜è®¢å•çŠ¶æ€
            if (paymentOrder.canTransitionTo(PaymentOrder.PaymentStatus.PAID)) {
                paymentOrder.transitionTo(PaymentOrder.PaymentStatus.PAID);
                paymentOrderRepository.save(paymentOrder);
            }

            // ç¡®è®¤åº“å­˜æ‰£å‡
            if (!inventoryService.confirmInventory(paymentOrder.getOrderNo())) {
                PaymentLog.error(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, 
                    new RuntimeException("ç¡®è®¤åº“å­˜æ‰£å‡å¤±è´¥"))
                    .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());
                // æ³¨æ„ï¼šè¿™é‡Œä¸è¿”å›falseï¼Œå› ä¸ºæ”¯ä»˜å·²ç»æˆåŠŸï¼Œåº“å­˜ç¡®è®¤å¤±è´¥éœ€è¦äººå·¥å¤„ç†
            }

            // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå¾…å‘è´§
            Order order = orderRepository.findByOrderNo(paymentOrder.getOrderNo())
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
            
            // ğŸ”¥ ä¿®å¤ï¼šæ”¯ä»˜æˆåŠŸæ—¶ï¼Œæ— è®ºå½“å‰çŠ¶æ€æ˜¯ä»€ä¹ˆéƒ½æ›´æ–°ä¸ºå¾…å‘è´§ï¼ˆé˜²æ­¢è¶…æ—¶ä»»åŠ¡å·²ç»å–æ¶ˆäº†è®¢å•ï¼‰
            if (order.getStatus() == Order.OrderStatus.PENDING_PAYMENT || 
                order.getStatus() == Order.OrderStatus.CANCELLED) {
                order.setStatus(Order.OrderStatus.PENDING_SHIPMENT); // æ”¯ä»˜æˆåŠŸåæ›´æ–°ä¸ºå¾…å‘è´§çŠ¶æ€
                orderRepository.save(order);
                
                // ğŸ”¥ æ”¯ä»˜æˆåŠŸåå‘å¸ƒäº‹ä»¶ï¼Œå–æ¶ˆè®¢å•è¶…æ—¶ä»»åŠ¡
                publishPaymentSuccessEvent(paymentOrder.getOrderNo(), paymentOrder.getAlipayTradeNo(), "TRADE_SUCCESS");
            }

            // è®°å½•çŠ¶æ€æ›´æ–°æ—¥å¿—
            PaymentLog.info(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, 
                "æ”¯ä»˜æˆåŠŸï¼Œè®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºå¾…å‘è´§ï¼Œè¶…æ—¶ä»»åŠ¡å·²å–æ¶ˆ")
                .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());

            return true;

        } catch (Exception e) {
            PaymentLog.error(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, e)
                .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());
            return false;
        }
    }

    /**
     * å¤„ç†æ”¯ä»˜å…³é—­
     * @param paymentOrder æ”¯ä»˜è®¢å•
     * @param params å›è°ƒå‚æ•°
     * @return å¤„ç†ç»“æœ
     */
    private boolean handlePaymentClosed(PaymentOrder paymentOrder, Map<String, String> params) {
        try {
            // æ›´æ–°æ”¯ä»˜è®¢å•çŠ¶æ€
            if (paymentOrder.canTransitionTo(PaymentOrder.PaymentStatus.CANCELLED)) {
                paymentOrder.transitionTo(PaymentOrder.PaymentStatus.CANCELLED);
                paymentOrderRepository.save(paymentOrder);
            }

            // è®°å½•çŠ¶æ€æ›´æ–°æ—¥å¿—
            PaymentLog.info(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, 
                "æ”¯ä»˜å·²å…³é—­")
                .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());

            return true;

        } catch (Exception e) {
            PaymentLog.error(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, e)
                .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());
            return false;
        }
    }

    /**
     * å¤„ç†æ”¯ä»˜å¾…å¤„ç†
     * @param paymentOrder æ”¯ä»˜è®¢å•
     * @param params å›è°ƒå‚æ•°
     * @return å¤„ç†ç»“æœ
     */
    private boolean handlePaymentPending(PaymentOrder paymentOrder, Map<String, String> params) {
        try {
            // ç¡®ä¿æ”¯ä»˜è®¢å•çŠ¶æ€ä¸ºå¾…æ”¯ä»˜
            if (paymentOrder.getStatus() != PaymentOrder.PaymentStatus.PENDING) {
                if (paymentOrder.canTransitionTo(PaymentOrder.PaymentStatus.PENDING)) {
                    paymentOrder.transitionTo(PaymentOrder.PaymentStatus.PENDING);
                    paymentOrderRepository.save(paymentOrder);
                }
            }

            // è®°å½•çŠ¶æ€æ›´æ–°æ—¥å¿—
            PaymentLog.info(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, 
                "ç­‰å¾…ä¹°å®¶ä»˜æ¬¾")
                .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());

            return true;

        } catch (Exception e) {
            PaymentLog.error(paymentOrder.getOrderNo(), PaymentLog.LogOperation.STATUS_UPDATE, e)
                .withAlipayTradeNo(paymentOrder.getAlipayTradeNo());
            return false;
        }
    }

    /**
     * åŒæ­¥æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€å¹¶æ›´æ–°æœ¬åœ°çŠ¶æ€
     * @param orderNo è®¢å•å·
     * @return åŒæ­¥ç»“æœ
     */
    public Map<String, Object> syncPaymentStatusFromAlipay(String orderNo) {
        long startTime = System.currentTimeMillis();
        Map<String, Object> result = new HashMap<>();
        
        try {
            // æŸ¥è¯¢æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€
            AlipayTradeQueryResponse response = queryAlipayTradeStatus(orderNo);
            
            if (!response.isSuccess()) {
                result.put("success", false);
                result.put("message", "æŸ¥è¯¢æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€å¤±è´¥ï¼š" + response.getSubMsg());
                return result;
            }

            // è·å–æœ¬åœ°æ”¯ä»˜è®¢å•
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            if (paymentOrderOpt.isEmpty()) {
                result.put("success", false);
                result.put("message", "æœ¬åœ°æ”¯ä»˜è®¢å•ä¸å­˜åœ¨");
                return result;
            }

            PaymentOrder paymentOrder = paymentOrderOpt.get();
            String alipayTradeStatus = response.getTradeStatus();
            
            // æ›´æ–°æ”¯ä»˜å®äº¤æ˜“å·
            if (response.getTradeNo() != null && !response.getTradeNo().equals(paymentOrder.getAlipayTradeNo())) {
                paymentOrder.setAlipayTradeNo(response.getTradeNo());
            }

            // æ ¹æ®æ”¯ä»˜å®çŠ¶æ€æ›´æ–°æœ¬åœ°çŠ¶æ€
            boolean statusUpdated = false;
            PaymentOrder.PaymentStatus newStatus = null;

            switch (alipayTradeStatus) {
                case "TRADE_SUCCESS":
                case "TRADE_FINISHED":
                    if (!paymentOrder.isPaid()) {
                        newStatus = PaymentOrder.PaymentStatus.PAID;
                        statusUpdated = true;
                    }
                    break;
                    
                case "TRADE_CLOSED":
                    if (paymentOrder.getStatus() != PaymentOrder.PaymentStatus.CANCELLED) {
                        newStatus = PaymentOrder.PaymentStatus.CANCELLED;
                        statusUpdated = true;
                    }
                    break;
                    
                case "WAIT_BUYER_PAY":
                    if (paymentOrder.getStatus() != PaymentOrder.PaymentStatus.PENDING) {
                        newStatus = PaymentOrder.PaymentStatus.PENDING;
                        statusUpdated = true;
                    }
                    break;
            }

            // æ›´æ–°çŠ¶æ€
            if (statusUpdated && newStatus != null) {
                if (paymentOrder.canTransitionTo(newStatus)) {
                    paymentOrder.transitionTo(newStatus);
                    paymentOrderRepository.save(paymentOrder);
                    
                    // å¦‚æœæ”¯ä»˜æˆåŠŸï¼ŒåŒæ—¶æ›´æ–°è®¢å•çŠ¶æ€
                    if (newStatus == PaymentOrder.PaymentStatus.PAID) {
                        updateOrderStatusAfterPayment(orderNo);
                    }
                    
                    // è®°å½•åŒæ­¥æ—¥å¿—
                    PaymentLog.info(orderNo, PaymentLog.LogOperation.STATUS_UPDATE, 
                        "ä»æ”¯ä»˜å®åŒæ­¥çŠ¶æ€æˆåŠŸï¼š" + alipayTradeStatus + " -> " + newStatus)
                        .withAlipayTradeNo(paymentOrder.getAlipayTradeNo())
                        .withExecutionTime(startTime);
                }
            }

            result.put("success", true);
            result.put("alipayStatus", alipayTradeStatus);
            result.put("localStatus", paymentOrder.getStatus());
            result.put("statusUpdated", statusUpdated);
            result.put("paymentOrder", paymentOrder);
            
            return result;

        } catch (Exception e) {
            PaymentLog.error(orderNo, PaymentLog.LogOperation.PAYMENT_QUERY, e)
                .withExecutionTime(startTime);
            
            result.put("success", false);
            result.put("message", "åŒæ­¥æ”¯ä»˜çŠ¶æ€å¤±è´¥ï¼š" + e.getMessage());
            return result;
        }
    }

    /**
     * æ”¯ä»˜æˆåŠŸåæ›´æ–°è®¢å•çŠ¶æ€
     * @param orderNo è®¢å•å·
     */
    private void updateOrderStatusAfterPayment(String orderNo) {
        try {
            // ç¡®è®¤åº“å­˜æ‰£å‡
            if (!inventoryService.confirmInventory(orderNo)) {
                PaymentLog.error(orderNo, PaymentLog.LogOperation.ORDER_UPDATE, 
                    new RuntimeException("ç¡®è®¤åº“å­˜æ‰£å‡å¤±è´¥"));
            }

            Order order = orderRepository.findByOrderNo(orderNo)
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
            
            if (order.getStatus() == Order.OrderStatus.PENDING_PAYMENT) {
                order.setStatus(Order.OrderStatus.PENDING_SHIPMENT); // æ”¯ä»˜æˆåŠŸåæ”¹ä¸ºå¾…å‘è´§çŠ¶æ€
                orderRepository.save(order);
                
                PaymentLog.info(orderNo, PaymentLog.LogOperation.ORDER_UPDATE, 
                    "æ”¯ä»˜æˆåŠŸåè®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºå¾…å‘è´§");
            }
        } catch (Exception e) {
            PaymentLog.error(orderNo, PaymentLog.LogOperation.ORDER_UPDATE, e);
        }
    }

    /**
     * è·å–è¯¦ç»†çš„æ”¯ä»˜çŠ¶æ€ä¿¡æ¯
     * @param orderNo è®¢å•å·
     * @return æ”¯ä»˜çŠ¶æ€è¯¦æƒ…
     */
    @Transactional(readOnly = true)
    public Map<String, Object> getDetailedPaymentStatus(String orderNo) {
        Map<String, Object> result = new HashMap<>();
        
        try {
            // è·å–è®¢å•ä¿¡æ¯
            Order order = orderRepository.findByOrderNo(orderNo)
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
            
            // è·å–æ”¯ä»˜è®¢å•ä¿¡æ¯
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            
            // è·å–æ”¯ä»˜å†å²è®°å½•
            List<PaymentLog> paymentHistory = paymentLogRepository.findByOrderNoOrderByCreateTimeDesc(orderNo);
            
            result.put("order", order);
            result.put("paymentOrder", paymentOrderOpt.orElse(null));
            result.put("paymentHistory", paymentHistory);
            result.put("hasPaymentOrder", paymentOrderOpt.isPresent());
            
            if (paymentOrderOpt.isPresent()) {
                PaymentOrder paymentOrder = paymentOrderOpt.get();
                result.put("isPaid", paymentOrder.isPaid());
                result.put("canCancel", paymentOrder.canCancel());
                result.put("isTimeout", paymentOrder.isTimeout());
                result.put("paymentStatus", paymentOrder.getStatus());
                result.put("paymentAmount", paymentOrder.getAmount());
                result.put("alipayTradeNo", paymentOrder.getAlipayTradeNo());
                result.put("createTime", paymentOrder.getCreateTime());
                result.put("payTime", paymentOrder.getPayTime());
            }
            
            return result;
            
        } catch (Exception e) {
            result.put("error", e.getMessage());
            return result;
        }
    }

    /**
     * è·å–ç”¨æˆ·çš„æ”¯ä»˜è®¢å•åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @return æ”¯ä»˜è®¢å•åˆ—è¡¨
     */
    @Transactional(readOnly = true)
    public List<PaymentOrder> getUserPaymentOrders(Long userId) {
        return paymentOrderRepository.findByBuyerIdOrderByCreateTimeDesc(userId);
    }

    /**
     * è·å–ç”¨æˆ·æŒ‡å®šçŠ¶æ€çš„æ”¯ä»˜è®¢å•åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @param status æ”¯ä»˜çŠ¶æ€
     * @return æ”¯ä»˜è®¢å•åˆ—è¡¨
     */
    @Transactional(readOnly = true)
    public List<PaymentOrder> getUserPaymentOrdersByStatus(Long userId, PaymentOrder.PaymentStatus status) {
        return paymentOrderRepository.findByBuyerIdAndStatusOrderByCreateTimeDesc(userId, status);
    }

    /**
     * æ‰¹é‡æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
     * @param orderNos è®¢å•å·åˆ—è¡¨
     * @return æ”¯ä»˜çŠ¶æ€æ˜ å°„
     */
    @Transactional(readOnly = true)
    public Map<String, PaymentOrder.PaymentStatus> batchGetPaymentStatus(List<String> orderNos) {
        Map<String, PaymentOrder.PaymentStatus> statusMap = new HashMap<>();
        
        for (String orderNo : orderNos) {
            Optional<PaymentOrder> paymentOrder = paymentOrderRepository.findById(orderNo);
            if (paymentOrder.isPresent()) {
                statusMap.put(orderNo, paymentOrder.get().getStatus());
            } else {
                statusMap.put(orderNo, null); // æœªåˆ›å»ºæ”¯ä»˜è®¢å•
            }
        }
        
        return statusMap;
    }

    /**
     * æ£€æŸ¥æ”¯ä»˜è®¢å•æ˜¯å¦è¶…æ—¶
     * @param orderNo è®¢å•å·
     * @return è¶…æ—¶æ£€æŸ¥ç»“æœ
     */
    @Transactional(readOnly = true)
    public Map<String, Object> checkPaymentTimeout(String orderNo) {
        Map<String, Object> result = new HashMap<>();
        
        try {
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            
            if (paymentOrderOpt.isEmpty()) {
                result.put("exists", false);
                result.put("message", "æ”¯ä»˜è®¢å•ä¸å­˜åœ¨");
                return result;
            }
            
            PaymentOrder paymentOrder = paymentOrderOpt.get();
            boolean isTimeout = paymentOrder.isTimeout();
            
            result.put("exists", true);
            result.put("isTimeout", isTimeout);
            result.put("status", paymentOrder.getStatus());
            result.put("createTime", paymentOrder.getCreateTime());
            result.put("timeoutExpress", paymentOrder.getTimeoutExpress());
            
            if (isTimeout && paymentOrder.getStatus() == PaymentOrder.PaymentStatus.PENDING) {
                result.put("canMarkTimeout", true);
                result.put("message", "æ”¯ä»˜è®¢å•å·²è¶…æ—¶ï¼Œå¯ä»¥æ ‡è®°ä¸ºè¶…æ—¶çŠ¶æ€");
            } else {
                result.put("canMarkTimeout", false);
            }
            
            return result;
            
        } catch (Exception e) {
            result.put("error", e.getMessage());
            return result;
        }
    }

    /**
     * å¤„ç†æ”¯ä»˜è¶…æ—¶
     * ç”±è¶…æ—¶ä»»åŠ¡è°ƒåº¦å™¨è°ƒç”¨
     * @param orderNo è®¢å•å·
     * @return å¤„ç†ç»“æœ
     */
    @Transactional(rollbackFor = Exception.class)
    public boolean handlePaymentTimeout(String orderNo) {
        long startTime = System.currentTimeMillis();
        
        try {
            // æŸ¥è¯¢æ”¯ä»˜è®¢å•
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            if (paymentOrderOpt.isEmpty()) {
                PaymentLog.warn(orderNo, PaymentLog.LogOperation.TIMEOUT_HANDLE, 
                    "å¤„ç†æ”¯ä»˜è¶…æ—¶æ—¶æ”¯ä»˜è®¢å•ä¸å­˜åœ¨")
                    .withExecutionTime(startTime);
                return false;
            }

            PaymentOrder paymentOrder = paymentOrderOpt.get();
            
            // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼Œå¦‚æœå·²æ”¯ä»˜åˆ™ä¸éœ€è¦å¤„ç†
            if (paymentOrder.isPaid()) {
                PaymentLog.info(orderNo, PaymentLog.LogOperation.TIMEOUT_HANDLE, 
                    "æ”¯ä»˜è®¢å•å·²æ”¯ä»˜ï¼Œè·³è¿‡è¶…æ—¶å¤„ç†")
                    .withAlipayTradeNo(paymentOrder.getAlipayTradeNo())
                    .withExecutionTime(startTime);
                return true;
            }

            // ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€
            try {
                AlipayTradeQueryResponse response = queryAlipayTradeStatus(orderNo);
                if (response.isSuccess()) {
                    String tradeStatus = response.getTradeStatus();
                    
                    // å¦‚æœæ”¯ä»˜å®æ˜¾ç¤ºå·²æ”¯ä»˜ï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
                    if ("TRADE_SUCCESS".equals(tradeStatus) || "TRADE_FINISHED".equals(tradeStatus)) {
                        Map<String, String> params = new HashMap<>();
                        params.put("out_trade_no", orderNo);
                        params.put("trade_no", response.getTradeNo());
                        params.put("trade_status", tradeStatus);
                        
                        boolean processed = processPaymentResult(orderNo, response.getTradeNo(), tradeStatus, params);
                        
                        PaymentLog.info(orderNo, PaymentLog.LogOperation.TIMEOUT_HANDLE, 
                            "è¶…æ—¶å¤„ç†æ—¶å‘ç°æ”¯ä»˜å·²å®Œæˆï¼ŒçŠ¶æ€å·²åŒæ­¥")
                            .withAlipayTradeNo(response.getTradeNo())
                            .withExecutionTime(startTime);
                        
                        return processed;
                    }
                }
            } catch (Exception e) {
                PaymentLog.warn(orderNo, PaymentLog.LogOperation.TIMEOUT_HANDLE, 
                    "æŸ¥è¯¢æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€å¤±è´¥ï¼š" + e.getMessage())
                    .withExecutionTime(startTime);
            }

            // å¦‚æœç¡®å®è¶…æ—¶ä¸”æœªæ”¯ä»˜ï¼Œæ ‡è®°ä¸ºè¶…æ—¶çŠ¶æ€
            if (paymentOrder.isTimeout() && paymentOrder.getStatus() == PaymentOrder.PaymentStatus.PENDING) {
                if (paymentOrder.canTransitionTo(PaymentOrder.PaymentStatus.TIMEOUT)) {
                    paymentOrder.transitionTo(PaymentOrder.PaymentStatus.TIMEOUT);
                    paymentOrderRepository.save(paymentOrder);
                    
                    PaymentLog.info(orderNo, PaymentLog.LogOperation.TIMEOUT_HANDLE, 
                        "æ”¯ä»˜è®¢å•å·²æ ‡è®°ä¸ºè¶…æ—¶çŠ¶æ€")
                        .withExecutionTime(startTime);
                }
            }

            return true;

        } catch (Exception e) {
            PaymentLog.error(orderNo, PaymentLog.LogOperation.TIMEOUT_HANDLE, e)
                .withExecutionTime(startTime);
            return false;
        }
    }

    /**
     * å¤„ç†å›è°ƒè¶…æ—¶
     * å½“æ”¯ä»˜å›è°ƒé•¿æ—¶é—´æœªæ”¶åˆ°æ—¶ï¼Œä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
     * @param orderNo è®¢å•å·
     * @return å¤„ç†ç»“æœ
     */
    @Transactional(rollbackFor = Exception.class)
    public boolean handleCallbackTimeout(String orderNo) {
        long startTime = System.currentTimeMillis();
        
        try {
            // æŸ¥è¯¢æ”¯ä»˜è®¢å•
            Optional<PaymentOrder> paymentOrderOpt = paymentOrderRepository.findById(orderNo);
            if (paymentOrderOpt.isEmpty()) {
                PaymentLog.warn(orderNo, PaymentLog.LogOperation.CALLBACK_TIMEOUT, 
                    "å¤„ç†å›è°ƒè¶…æ—¶æ—¶æ”¯ä»˜è®¢å•ä¸å­˜åœ¨")
                    .withExecutionTime(startTime);
                return false;
            }

            PaymentOrder paymentOrder = paymentOrderOpt.get();
            
            // å¦‚æœå·²ç»æœ‰æ˜ç¡®çŠ¶æ€ï¼Œä¸éœ€è¦å¤„ç†
            if (paymentOrder.getStatus() != PaymentOrder.PaymentStatus.PENDING) {
                PaymentLog.info(orderNo, PaymentLog.LogOperation.CALLBACK_TIMEOUT, 
                    "æ”¯ä»˜è®¢å•çŠ¶æ€å·²ç¡®å®šï¼Œè·³è¿‡å›è°ƒè¶…æ—¶å¤„ç†ï¼š" + paymentOrder.getStatus())
                    .withAlipayTradeNo(paymentOrder.getAlipayTradeNo())
                    .withExecutionTime(startTime);
                return true;
            }

            // ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜å®äº¤æ˜“çŠ¶æ€
            try {
                Map<String, Object> syncResult = syncPaymentStatusFromAlipay(orderNo);
                boolean success = (Boolean) syncResult.getOrDefault("success", false);
                
                if (success) {
                    PaymentLog.info(orderNo, PaymentLog.LogOperation.CALLBACK_TIMEOUT, 
                        "å›è°ƒè¶…æ—¶å¤„ç†å®Œæˆï¼ŒçŠ¶æ€å·²åŒæ­¥ï¼š" + syncResult.get("localStatus"))
                        .withExecutionTime(startTime);
                    return true;
                } else {
                    PaymentLog.warn(orderNo, PaymentLog.LogOperation.CALLBACK_TIMEOUT, 
                        "å›è°ƒè¶…æ—¶å¤„ç†å¤±è´¥ï¼š" + syncResult.get("message"))
                        .withExecutionTime(startTime);
                    return false;
                }
                
            } catch (Exception e) {
                PaymentLog.error(orderNo, PaymentLog.LogOperation.CALLBACK_TIMEOUT, e)
                    .withExecutionTime(startTime);
                return false;
            }

        } catch (Exception e) {
            PaymentLog.error(orderNo, PaymentLog.LogOperation.CALLBACK_TIMEOUT, e)
                .withExecutionTime(startTime);
            return false;
        }
    }
}