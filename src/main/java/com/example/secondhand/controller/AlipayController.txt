package com.example.secondhand.controller;

import com.alipay.api.AlipayApiException;
import com.alipay.api.response.AlipayTradeQueryResponse;
import com.example.secondhand.common.Result;
import com.example.secondhand.dto.PayRequest;
import com.example.secondhand.entity.PaymentOrder;
import com.example.secondhand.service.PaymentService;
import com.example.secondhand.common.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.List;
import java.util.Map;
import java.util.Optional;

@RestController
@RequestMapping("/api/pay")
public class AlipayController {

    @Autowired
    private PaymentService paymentService;

    /**
     * 发起支付宝网页支付
     * 支持真实订单数据，包含订单验证和库存检查
     */
    @PostMapping(value = "/alipay", produces = "text/html;charset=UTF-8")
    public String alipay(@RequestBody PayRequest payRequest, HttpServletRequest request) {
        try {
            // 1. 从JWT获取用户ID
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                throw new RuntimeException("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 2. 验证请求参数
            if (payRequest.getOrderId() == null || payRequest.getOrderId().trim().isEmpty()) {
                throw new RuntimeException("订单号不能为空");
            }
            
            // 3. 设置回调地址
            String returnUrl = "http://localhost:5173/pay/success?orderNo=" + payRequest.getOrderId();
            String notifyUrl = "http://localhost:8080/api/pay/notify";
            
            // 4. 调用支付服务发起支付
            return paymentService.initiateAlipayPayment(
                payRequest.getOrderId(), 
                userId, 
                returnUrl, 
                notifyUrl
            );
            
        } catch (Exception e) {
            // 返回错误页面
            return generateErrorPage("支付发起失败：" + e.getMessage());
        }
    }

    /**
     * 查询支付状态
     */
    @GetMapping("/status/{orderNo}")
    public Result<PaymentOrder> getPaymentStatus(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 查询支付状态
            Optional<PaymentOrder> paymentOrder = paymentService.getPaymentStatus(orderNo);
            
            if (paymentOrder.isPresent()) {
                // 验证权限
                if (!paymentOrder.get().getBuyerId().equals(userId)) {
                    return Result.error("无权限查看此订单支付状态");
                }
                return Result.success(paymentOrder.get());
            } else {
                return Result.error("支付订单不存在");
            }
            
        } catch (Exception e) {
            return Result.error("查询支付状态失败：" + e.getMessage());
        }
    }

    /**
     * 主动同步支付宝交易状态
     */
    @PostMapping("/sync/{orderNo}")
    public Result<String> syncPaymentStatus(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 验证订单权限
            Optional<PaymentOrder> paymentOrder = paymentService.getPaymentStatus(orderNo);
            if (paymentOrder.isEmpty() || !paymentOrder.get().getBuyerId().equals(userId)) {
                return Result.error("无权限操作此订单");
            }
            
            // 查询支付宝交易状态
            AlipayTradeQueryResponse response = paymentService.queryAlipayTradeStatus(orderNo);
            
            if (response.isSuccess()) {
                return Result.success("同步成功，交易状态：" + response.getTradeStatus());
            } else {
                return Result.error("同步失败：" + response.getSubMsg());
            }
            
        } catch (Exception e) {
            return Result.error("同步支付状态失败：" + e.getMessage());
        }
    }

    /**
     * 取消支付
     */
    @PostMapping("/cancel/{orderNo}")
    public Result<String> cancelPayment(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 取消支付
            paymentService.cancelPayment(orderNo, userId);
            
            return Result.success("支付已取消");
            
        } catch (Exception e) {
            return Result.error("取消支付失败：" + e.getMessage());
        }
    }

    /**
     * 检查支付资格
     */
    @GetMapping("/check/{orderNo}")
    public Result<Map<String, Object>> checkPaymentEligibility(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 检查支付资格
            Map<String, Object> result = paymentService.checkPaymentEligibility(orderNo, userId);
            
            return Result.success(result);
            
        } catch (Exception e) {
            return Result.error("检查支付资格失败：" + e.getMessage());
        }
    }

    /**
     * 获取详细支付状态信息
     */
    @GetMapping("/detail/{orderNo}")
    public Result<Map<String, Object>> getDetailedPaymentStatus(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 获取详细支付状态
            Map<String, Object> result = paymentService.getDetailedPaymentStatus(orderNo);
            
            // 验证权限
            if (result.containsKey("order")) {
                com.example.secondhand.entity.Order order = 
                    (com.example.secondhand.entity.Order) result.get("order");
                if (!order.getBuyerId().equals(userId)) {
                    return Result.error("无权限查看此订单支付详情");
                }
            }
            
            return Result.success(result);
            
        } catch (Exception e) {
            return Result.error("获取支付详情失败：" + e.getMessage());
        }
    }

    /**
     * 获取用户支付订单列表
     */
    @GetMapping("/orders")
    public Result<List<PaymentOrder>> getUserPaymentOrders(HttpServletRequest request,
                                                          @RequestParam(required = false) String status) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            List<PaymentOrder> paymentOrders;
            
            if (status != null && !status.trim().isEmpty()) {
                // 按状态查询
                PaymentOrder.PaymentStatus paymentStatus = PaymentOrder.PaymentStatus.valueOf(status.toUpperCase());
                paymentOrders = paymentService.getUserPaymentOrdersByStatus(userId, paymentStatus);
            } else {
                // 查询全部
                paymentOrders = paymentService.getUserPaymentOrders(userId);
            }
            
            return Result.success(paymentOrders);
            
        } catch (IllegalArgumentException e) {
            return Result.error("无效的支付状态参数：" + status);
        } catch (Exception e) {
            return Result.error("获取支付订单列表失败：" + e.getMessage());
        }
    }

    /**
     * 批量查询支付状态
     */
    @PostMapping("/batch-status")
    public Result<Map<String, PaymentOrder.PaymentStatus>> batchGetPaymentStatus(
            @RequestBody List<String> orderNos, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 验证订单数量限制
            if (orderNos == null || orderNos.isEmpty()) {
                return Result.error("订单号列表不能为空");
            }
            
            if (orderNos.size() > 50) {
                return Result.error("单次查询订单数量不能超过50个");
            }
            
            // TODO: 这里应该验证所有订单都属于当前用户，为简化暂时跳过
            
            Map<String, PaymentOrder.PaymentStatus> statusMap = 
                paymentService.batchGetPaymentStatus(orderNos);
            
            return Result.success(statusMap);
            
        } catch (Exception e) {
            return Result.error("批量查询支付状态失败：" + e.getMessage());
        }
    }

    /**
     * 检查支付超时
     */
    @GetMapping("/timeout/{orderNo}")
    public Result<Map<String, Object>> checkPaymentTimeout(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // 验证用户权限
            String token = request.getHeader("Authorization");
            if (token == null || !token.startsWith("Bearer ")) {
                return Result.error("未登录或token无效");
            }
            
            String jwt = token.substring(7);
            Long userId = JwtUtil.getUserId(jwt);
            
            // 验证订单权限
            Optional<PaymentOrder> paymentOrder = paymentService.getPaymentStatus(orderNo);
            if (paymentOrder.isEmpty() || !paymentOrder.get().getBuyerId().equals(userId)) {
                return Result.error("无权限查看此订单");
            }
            
            // 检查超时状态
            Map<String, Object> result = paymentService.checkPaymentTimeout(orderNo);
            
            return Result.success(result);
            
        } catch (Exception e) {
            return Result.error("检查支付超时失败：" + e.getMessage());
        }
    }

    /**
     * 支付宝异步通知处理
     * 包含签名验证、幂等性处理和订单状态更新
     */
    @PostMapping("/notify")
    public String notify(@RequestParam Map<String, String> params) {
        try {
            // 调用支付服务处理回调
            return paymentService.handleAlipayCallback(params);
        } catch (Exception e) {
            // 记录异常但不抛出，避免影响支付宝重试机制
            System.err.println("处理支付宝回调异常：" + e.getMessage());
            e.printStackTrace();
            return "failure";
        }
    }

    /**
     * 生成错误页面
     */
    private String generateErrorPage(String errorMessage) {
        return "<!DOCTYPE html>" +
               "<html><head><meta charset='UTF-8'><title>支付失败</title></head>" +
               "<body style='text-align:center;padding:50px;font-family:Arial,sans-serif;'>" +
               "<h2 style='color:#ff4d4f;'>支付发起失败</h2>" +
               "<p>" + errorMessage + "</p>" +
               "<button onclick='window.history.back()' style='padding:10px 20px;background:#1890ff;color:white;border:none;border-radius:4px;cursor:pointer;'>返回</button>" +
               "</body></html>";
    }
}